variables:
  DOCKER_BUILDKIT: '1'
  ROCK_NAME: $CI_PROJECT_NAME

stages:
  - build
  - publish

.in-docker:
  image: tarantool/tarantool:1.x-centos7
  tags:
    - docker
  before_script:
    - yum -y install git-core cmake curl make
    - tarantoolctl rocks install luacheck
  variables:
    CMAKE_LDOC_FIND_REQUIRED: "YES"

build:
  extends: .in-docker
  stage: build
  script:
    - tarantoolctl rocks make
    - tarantool taptest.lua
    - .rocks/bin/luacheck .

publish-scm-1-rock:
  extends: .in-docker
  stage: publish
  only:
    - master
  script:
    - tarantoolctl rocks make
    - tarantoolctl rocks pack ${ROCK_NAME}
    - curl --fail -X PUT -F "rockspec=@$ROCK_NAME-scm-1.rockspec"
      https://$ROCKS_USERNAME:$ROCKS_PASSWORD@rocks.tarantool.org

publish-release-rock:
  extends: .in-docker
  stage: publish
  only:
    - tags
  script:
    - cat $ROCK_NAME-scm-1.rockspec |
      sed -E
      -e "s/branch = '.+'/tag = '$CI_COMMIT_TAG'/g"
      -e "s/version = '.+'/version = '$CI_COMMIT_TAG-1'/g" > $ROCK_NAME-$CI_COMMIT_TAG-1.rockspec
    - tarantoolctl rocks make $ROCK_NAME-$CI_COMMIT_TAG-1.rockspec
    - tarantoolctl rocks pack ${ROCK_NAME}
    - curl --fail -X PUT -F "rockspec=$ROCK_NAME-$CI_COMMIT_TAG-1.rockspec"
      https://$ROCKS_USERNAME:$ROCKS_PASSWORD@rocks.tarantool.org
    - curl --fail -X PUT -F "rockspec=$ROCK_NAME-$CI_COMMIT_TAG-1.all.rock"
      https://$ROCKS_USERNAME:$ROCKS_PASSWORD@rocks.tarantool.org
